<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live APP</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
</head>
<body>
    <h1>Livekit Video Chat</h1>
    <div id="localVideo">
    </div>
    <div id="remoteVideos" style="border: 1px solid black; width: 300; height: 300px;"></div>
    <button id="connect">Connect</button>
    <script>
        const {
            Participant,
            RemoteParticipant,
            RemoteTrack,
            RemoteTrackPublication,
            RoomEvent,
        } = LivekitClient
        const url = 'wss://chat-app-oluzbac4.livekit.cloud';

        const room = new LivekitClient.Room({
            audioCaptureDefaults: {
                autoGainControl: true,
                deviceId: '',
                echoCancellation: true,
                noiseSuppression: true,
            },
            videoCaptureDefaults: {
                deviceId: '',
                facingMode: 'user',
                resolution: {
                width: 1280,
                height: 720,
                frameRate: 30,
                },
            },
            publishDefaults: {
                videoEncoding: {
                maxBitrate: 1_500_000,
                maxFramerate: 30,
                },
                screenShareEncoding: {
                maxBitrate: 1_500_000,
                maxFramerate: 30,
                },
                audioBitrate: 20_000,
                dtx: true,
                // only needed if overriding defaults
                videoSimulcastLayers: [
                {
                    width: 640,
                    height: 360,
                    encoding: {
                    maxBitrate: 500_000,
                    maxFramerate: 20,
                    }
                },
                {
                    width: 320,
                    height: 180,
                    encoding: {
                    maxBitrate: 150_000,
                    maxFramerate: 15,
                    }
                }
                ]
            },
        })

        document.querySelector('#connect').addEventListener('click', function() {
            connectRoom()
        })

        
        async function connectRoom(roomId) {
            const {token} = await fetchJSON('/getToken')
            await room.connect(url, token)

            await room.localParticipant.enableCameraAndMicrophone()
            room
            .on(RoomEvent.TrackSubscribed, handleTrackSubscribed)
            .on(RoomEvent.TrackUnsubscribed, handleTrackUnsubscribed)
            .on(RoomEvent.ActiveSpeakersChanged, handleActiveSpeakerChange)
            .on(RoomEvent.Disconnected, handleDisconnect)
            .on(RoomEvent.LocalTrackUnpublished, handleLocalTrackUnpublished);

        }

        function handleTrackSubscribed(RemoteTrack, RemoteTrackPublication, RemoteParticipant) {
            // if (track.kind === Track.Kind.Video || track.kind === Track.Kind.Audio) {
                // attach it to a new HTMLVideoElement or HTMLAudioElement
                const element = RemoteTrack.attach();
                document.querySelector('#remoteVideos').appendChild(element);
            // }
        }

        function handleTrackUnsubscribed(
            RemoteTrack,
            RemoteTrackPublication,
            RemoteParticipant,
        ) {
        // remove tracks from all attached elements
            RemoteTrack.detach();
        }

        function handleLocalTrackUnpublished(LocalTrackPublication, LocalParticipant) {
        // when local tracks are ended, update UI to remove them from rendering
            LocalTrackPublication.detach();
        }

        function handleActiveSpeakerChange(Participant) {
            // show UI indicators when participant is speaking
        }

        function handleDisconnect() {
             console.log('disconnected from room');
        }

        function addVideoTrack(track, containerId) {
            const videoElement = document.createElement('video')
            videoElement.srcObject = new MediaStream([track])
            videoElement.autoplay = true;
            document.getElementById(containerId).appendChild(videoElement);
        }

        async function fetchJSON(url, options = {}) {
            try {
                const response = await fetch('https://zany-puce-lamb-cap.cyclic.app/api' + url, options)
                if (!response.ok) {
                    const data = await response.json()
                    return alert(data.msg)
                }
                const data = await response.json()
                return data
            } catch (error) {
                console.log(error)
        }
    }
    </script>
</body>

</html>