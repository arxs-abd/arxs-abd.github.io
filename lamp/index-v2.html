<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Light Monitor - Server Sync</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #eef2f3; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; font-size: 1.1rem; text-align: center; }
        
        /* Status Display Styles */
        .display { text-align: center; margin: 15px 0; padding: 20px; border-radius: 12px; transition: all 0.3s; position: relative; overflow: hidden; }
        .status-text { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; letter-spacing: 1px; }
        .countdown { font-size: 4rem; font-weight: 800; line-height: 1; font-family: 'Courier New', Courier, monospace; }
        
        .status-merah { background: #ff4d4d; color: white; box-shadow: 0 0 20px rgba(255, 77, 77, 0.4); }
        .status-kuning { background: #ffcc00; color: #333; box-shadow: 0 0 20px rgba(255, 204, 0, 0.4); }
        .status-hijau { background: #2ecc71; color: white; box-shadow: 0 0 20px rgba(46, 204, 113, 0.4); }
        .status-off { background: #ddd; color: #999; }

        /* Form Styles */
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.85rem; color: #555; margin-bottom: 4px; font-weight: 600; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; outline: none; font-size: 16px; transition: border 0.3s; }
        input:focus { border-color: #2ecc71; }
        .time-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .time-inputs input { text-align: center; }
        .helper-text { font-size: 0.75rem; color: #888; margin-top: 4px; }

        /* Sync Status Badge */
        .sync-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: #eee;
            color: #666;
            margin-top: 10px;
            display: inline-block;
            border: 1px solid #ddd;
        }
        .sync-success { background: #e6fffa; color: #047481; border-color: #b2f5ea; }
        .sync-loading { background: #ebf8ff; color: #2b6cb0; border-color: #bee3f8; }
        .sync-error { background: #fff5f5; color: #c53030; border-color: #feb2b2; }
    </style>
</head>
<body>

    <div class="card">
        <h2>Konfigurasi Presisi</h2>
        <div class="input-group">
            <label>Tanggal Acuan</label>
            <input type="date" id="startDate">
        </div>
        <div class="input-group">
            <label>Waktu Acuan (Jam : Menit : Detik)</label>
            <div class="time-inputs">
                <input type="number" id="startHour" placeholder="Jam" min="0" max="23" value="8">
                <input type="number" id="startMinute" placeholder="Menit" min="0" max="59" value="0">
                <input type="number" id="startSecond" placeholder="Detik" min="0" max="59" value="0">
            </div>
            <div class="helper-text">Waktu mulai siklus pertama.</div>
        </div>
        <div class="input-group"><label>Merah (detik)</label><input type="number" id="durMerah"></div>
        <div class="input-group"><label>Hijau (detik)</label><input type="number" id="durHijau"></div>
        <div class="input-group"><label>Kuning (detik)</label><input type="number" id="durKuning"></div>
    </div>

    <div class="card">
        <div id="statusBox" class="display status-off">
            <div id="statusText" class="status-text">OFF</div>
            <div id="countdown" class="countdown">0</div>
        </div>
        
        <div style="text-align: center;">
            <div id="syncStatus" class="sync-badge sync-loading">
                ⏳ Menyelaraskan waktu server...
            </div>
            <div id="clockDisplay" style="margin-top:5px; font-size: 0.8rem; color: #888;">00:00:00</div>
        </div>
    </div>

    <script>
        // --- Bagian 1: Logika Sinkronisasi Server (Diambil dari Kode Map) ---
        
        let serverTimeOffset = 0; // Selisih waktu (ms)
        let isSynced = false;

        async function syncTime() {
            const statusEl = document.getElementById('syncStatus');
            const clientTimeStart = Date.now();
            
            try {
                // Mengambil trace dari Cloudflare untuk timestamp akurat
                const response = await fetch('https://cloudflare.com/cdn-cgi/trace', {
                    cache: 'no-store',
                    mode: 'cors'
                });
                
                if (!response.ok) throw new Error('Network err');
                
                const text = await response.text();
                const tsLine = text.split('\n').find(line => line.startsWith('ts='));
                
                if (!tsLine) throw new Error('No timestamp');
                
                // Timestamp server (dalam detik) -> ubah ke ms
                const serverTimestamp = parseFloat(tsLine.split('=')[1]) * 1000;
                
                const clientTimeEnd = Date.now();
                const latency = (clientTimeEnd - clientTimeStart) / 2; // Estimasi latensi satu arah
                
                // Waktu server yang disesuaikan dengan latensi
                const adjustedServerTime = serverTimestamp + latency;
                
                // Hitung offset: (Waktu Server Sebenarnya) - (Waktu Lokal Selesai Request)
                serverTimeOffset = adjustedServerTime - clientTimeEnd;
                isSynced = true;

                statusEl.className = 'sync-badge sync-success';
                statusEl.innerHTML = `✅ Terhubung Server (Offset: ${Math.round(serverTimeOffset)}ms)`;
                console.log("Time Synced. Offset:", serverTimeOffset);

            } catch (error) {
                console.error("Sync Failed:", error);
                statusEl.className = 'sync-badge sync-error';
                statusEl.innerText = '⚠️ Gagal Sync (Pakai Waktu Lokal)';
                isSynced = false;
                serverTimeOffset = 0; // Fallback ke 0
            }
        }

        // Fungsi pembantu untuk mendapatkan waktu "Sekarang" yang sudah dikoreksi
        function getCorrectedNow() {
            return new Date(Date.now() + serverTimeOffset);
        }

        // --- Bagian 2: Logika Traffic Light (Kode Asli yang di-update) ---

        const inputs = ['startDate', 'startHour', 'startMinute', 'startSecond', 'durMerah', 'durHijau', 'durKuning'];

        function loadData() {
            const savedData = localStorage.getItem('trafficConfigDate');
            if (savedData) {
                const config = JSON.parse(savedData);
                inputs.forEach(id => { 
                    const el = document.getElementById(id);
                    if (el && config[id] !== undefined) el.value = config[id];
                });
            } else {
                // Default value
                const now = new Date();
                document.getElementById('startDate').value = now.toISOString().slice(0, 10);
                document.getElementById('startHour').value = "8";
                document.getElementById('durMerah').value = "60";
                document.getElementById('durHijau').value = "40";
                document.getElementById('durKuning').value = "5";
            }
        }

        function saveData() {
            const config = {};
            inputs.forEach(id => { config[id] = document.getElementById(id).value; });
            localStorage.setItem('trafficConfigDate', JSON.stringify(config));
        }

        function updateTrafficLight() {
            // Update jam digital kecil untuk debug visual
            const now = getCorrectedNow(); // <-- PENTING: Pakai waktu terkoreksi
            document.getElementById('clockDisplay').innerText = now.toLocaleTimeString('id-ID');

            const startDate = document.getElementById('startDate').value;
            const startHour = parseInt(document.getElementById('startHour').value) || 0;
            const startMinute = parseInt(document.getElementById('startMinute').value) || 0;
            const startSecond = parseInt(document.getElementById('startSecond').value) || 0;
            
            const dMerah = parseInt(document.getElementById('durMerah').value) || 0;
            const dHijau = parseInt(document.getElementById('durHijau').value) || 0;
            const dKuning = parseInt(document.getElementById('durKuning').value) || 0;
            const totalSiklus = dMerah + dHijau + dKuning;

            if (totalSiklus === 0 || !startDate) return;

            const acuan = new Date(startDate);
            acuan.setHours(startHour, startMinute, startSecond, 0);

            // Hitung selisih menggunakan waktu server (now)
            let selisihDetik = Math.floor((now - acuan) / 1000);

            if (selisihDetik < 0) {
                document.getElementById('statusText').innerText = "BELUM MULAI";
                document.getElementById('statusBox').className = "display status-off";
                document.getElementById('countdown').innerText = Math.abs(selisihDetik);
                return;
            }

            let posisi = selisihDetik % totalSiklus;
            const statusBox = document.getElementById('statusBox');
            const statusText = document.getElementById('statusText');
            const countdownDisp = document.getElementById('countdown');
            
            let sisaWaktu = 0;

            // Logika Urutan: Merah -> Hijau -> Kuning
            if (posisi < dMerah) {
                statusText.innerText = "MERAH";
                statusBox.className = "display status-merah";
                sisaWaktu = dMerah - posisi;
            } else if (posisi < (dMerah + dHijau)) {
                statusText.innerText = "HIJAU";
                statusBox.className = "display status-hijau";
                sisaWaktu = (dMerah + dHijau) - posisi;
            } else {
                statusText.innerText = "KUNING";
                statusBox.className = "display status-kuning";
                sisaWaktu = totalSiklus - posisi;
            }

            countdownDisp.innerText = sisaWaktu;
        }

        // Event Listeners
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                saveData();
                updateTrafficLight();
            });
        });

        // Inisialisasi
        loadData();
        syncTime(); // <-- Panggil sync saat load pertama kali
        
        // Loop utama
        setInterval(updateTrafficLight, 1000); // Update UI tiap detik
        setInterval(syncTime, 60000); // Re-sync ke server tiap 1 menit agar offset tidak drift
        updateTrafficLight();
    </script>
</body>
</html>