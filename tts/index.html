<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cari Jawaban TTS MU</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Pencari Jawaban TTS</h1>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleHistory()" aria-label="History">
                    <span>üïê</span>
                    <span class="history-badge" id="historyBadge" style="display: none;">0</span>
                </button>
                <button class="icon-btn" onclick="toggleTheme()" aria-label="Toggle theme">
                    <span class="theme-icon">üåô</span>
                </button>
            </div>
        </header>

        <div class="search-box">
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="kwInput" 
                    placeholder="Masukkan kata kunci..."
                    autocomplete="off"
                >
                <button class="clear-input-btn" id="clearInputBtnKw" onclick="clearInputKw()" aria-label="Clear input">√ó</button>
            </div>
            <div class="input-wrapper">
                 <input 
                    type="text" 
                    id="ptInput" 
                    placeholder="Masukkan pattern teks... (RU??H) atau jumlah hurufnya (5)"
                    autocomplete="off"
                >
                <button class="clear-input-btn" id="clearInputBtnPt" onclick="clearInputPt()" aria-label="Clear input">√ó</button>
            </div>
            <button id="searchBtn" onclick="cariTTS()">Cari</button>
        </div>

        <div id="results">
            <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <p>Mulai dengan memasukkan kata kunci</p>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal-overlay" id="historyModal" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Riwayat Pencarian</h2>
                <button class="close-btn" onclick="toggleHistory()">√ó</button>
            </div>
            <div class="modal-body" id="historyList">
                <!-- History items will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="clear-all-btn" onclick="clearAllHistory()">Hapus Semua Riwayat</button>
            </div>
        </div>
    </div>

    <script>
        const kwInput = document.getElementById('kwInput');
        const ptInput = document.getElementById('ptInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultsDiv = document.getElementById('results');
        const themeIcon = document.querySelector('.theme-icon');
        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const historyBadge = document.getElementById('historyBadge');
        const clearInputBtnKw = document.getElementById('clearInputBtnKw');
        const clearInputBtnPt = document.getElementById('clearInputBtnPt');

        // Load theme preference
        const currentTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeIcon(currentTheme);

        // Load and update history badge
        updateHistoryBadge();

        // Show/hide clear button based on input
        kwInput.addEventListener('input', function() {
            if (this.value.trim()) {
                clearInputBtnKw.classList.add('visible');
            } else {
                clearInputBtnKw.classList.remove('visible');
            }
        });

        ptInput.addEventListener('input', function() {
            if (this.value.trim()) {
                clearInputBtnPt.classList.add('visible');
            } else {
                clearInputBtnPt.classList.remove('visible');
            }
        });

        // Handle help input conversion only after user finishes typing
        ptInput.addEventListener('blur', formatHelpInput);
        ptInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                formatHelpInput();
                cariTTS();
            }
        });

        // Enable Enter key to search
        kwInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                cariTTS();
            }
        });

        function clearInputKw() {
            kwInput.value = '';
            clearInputBtnKw.classList.remove('visible');
            kwInput.focus();
        }

        function clearInputPt() {
            ptInput.value = '';
            clearInputBtnPt.classList.remove('visible');
            ptInput.focus();
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function toggleHistory() {
            historyModal.classList.toggle('active');
            if (historyModal.classList.contains('active')) {
                loadHistory();
            }
        }

        function closeModalOnOverlay(event) {
            if (event.target === historyModal) {
                toggleHistory();
            }
        }

        function getHistory() {
            const history = localStorage.getItem('ttsHistory');
            return history ? JSON.parse(history) : [];
        }

        function saveToHistory(keyword) {
            let history = getHistory();
            
            // Remove duplicate if exists
            history = history.filter(item => item.keyword.toLowerCase() !== keyword.toLowerCase());
            
            // Add new item to beginning
            history.unshift({
                keyword: keyword,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 20 items
            if (history.length > 20) {
                history = history.slice(0, 20);
            }
            
            localStorage.setItem('ttsHistory', JSON.stringify(history));
            updateHistoryBadge();
        }

        function deleteHistoryItem(keyword) {
            let history = getHistory();
            history = history.filter(item => item.keyword !== keyword);
            localStorage.setItem('ttsHistory', JSON.stringify(history));
            loadHistory();
            updateHistoryBadge();
        }

        function clearAllHistory() {
            if (confirm('Hapus semua riwayat pencarian?')) {
                localStorage.removeItem('ttsHistory');
                loadHistory();
                updateHistoryBadge();
            }
        }

        function updateHistoryBadge() {
            const history = getHistory();
            if (history.length > 0) {
                historyBadge.textContent = history.length;
                historyBadge.style.display = 'block';
            } else {
                historyBadge.style.display = 'none';
            }
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffInSeconds = Math.floor((now - past) / 1000);
            
            if (diffInSeconds < 60) return 'Baru saja';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} menit lalu`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} jam lalu`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} hari lalu`;
            
            return past.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function loadHistory() {
            const history = getHistory();
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <div class="empty-history-icon">üì≠</div>
                        <p>Belum ada riwayat pencarian</p>
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = '';
            
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-content" onclick="searchFromHistory('${item.keyword.replace(/'/g, "\\'")}')">
                        <div class="history-keyword">${item.keyword}</div>
                        <div class="history-time">${formatTimeAgo(item.timestamp)}</div>
                    </div>
                    <button class="delete-history-btn" onclick="event.stopPropagation(); deleteHistoryItem('${item.keyword.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                `;
                historyList.appendChild(div);
            });
        }

        function searchFromHistory(keyword) {
            kwInput.value = keyword;
            toggleHistory();
            cariTTS();
        }

        function formatHelpInput() {
            const val = ptInput.value.trim();
            if (!val) return;

            if (/^\d+$/.test(val)) {
                // jika angka ‚Üí ubah ke tanda tanya sebanyak angka tsb
                ptInput.value = '?'.repeat(parseInt(val));
            } else {
                // jika huruf ‚Üí ubah ke huruf besar semua
                ptInput.value = val.toUpperCase();
            }
        }

        async function cariTTS() {
            const kw = kwInput.value.trim();
            const pt = ptInput.value.trim();

            if (!kw) {
                resultsDiv.innerHTML = '<p class="message error">Masukkan kata kunci terlebih dahulu</p>';
                return;
            }

            // Show loading
            searchBtn.disabled = true;
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Mencari...</p>
                </div>
            `;

            const url = `https://api.noparkeemart.my.id/phones-app/battleship/tts/answer?keyword=${encodeURIComponent(kw)}&pattern=${encodeURIComponent(pt)}`;

            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const list = data.results;

                if (!list || list.length === 0) {
                    resultsDiv.innerHTML = '<p class="message">Tidak ada hasil ditemukan</p>';
                    return;
                }

                // Save to history on successful search
                saveToHistory(kw);

                // Clear and display results
                resultsDiv.innerHTML = '';

                list.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'result-item';

                    const bintangPenuh = '‚óè'.repeat(item.star || 0);
                    const bintangKosong = '‚óã'.repeat(5 - (item.star || 0));

                    div.innerHTML = `
                        <div class="jawaban-line">
                            <span class="jawaban">${item.jawaban}</span>
                            <span class="stars">${bintangPenuh}${bintangKosong}</span>
                        </div>
                        <div class="petunjuk">${item.petunjuk}</div>
                    `;

                    resultsDiv.appendChild(div);
                });

            } catch (err) {
                resultsDiv.innerHTML = `<p class="message error">Gagal mengambil data: ${err.message}</p>`;
            } finally {
                searchBtn.disabled = false;
            }
        }
    </script>
</body>
</html>