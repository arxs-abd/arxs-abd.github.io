<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search Data</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" />

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <style>
      body {
        background-color: #f8f9fa;
      }
      /* Lebar maksimum diperluas */
      .container-fluid-custom {
        max-width: 95%; /* âœ… lebih lebar dari container biasa */
        margin: 0 auto;
      }
      .card {
        border-radius: 0.75rem;
      }
      .table-wrapper {
        overflow-x: auto;
      }
      /* Sesuaikan tinggi form agar proporsional */
      select.select2,
      .select2-container--bootstrap-5 .select2-selection {
        height: calc(2.5rem + 2px) !important;
        padding: 0.375rem 0.75rem;
      }
    </style>
  </head>

  <body class="bg-light">
    <div class="container-fluid-custom py-4">
      <!-- Form -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0 text-center">Search</h4>
        </div>

        <div class="card-body">
          <form id="searchForm">
            <!-- Baris 1 -->
            <div class="row mb-3">
              <div class="col-lg-6">
                <label for="name" class="form-label">Nama</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="Masukkan nama" />
              </div>
              <div class="col-lg-6">
                <label for="nik" class="form-label">NIK</label>
                <input type="text" class="form-control" id="nik" name="nik" placeholder="Masukkan NIK" />
              </div>
            </div>

            <!-- Baris 2 -->
            <div class="row mb-3">
              <div class="col-lg-3 col-md-6">
                <label for="province" class="form-label">Provinsi</label>
                <select class="form-select select2" id="province" name="province"></select>
              </div>
              <div class="col-lg-3 col-md-6">
                <label for="city" class="form-label">Kabupaten/Kota</label>
                <select class="form-select select2" id="city" name="city"></select>
              </div>
              <div class="col-lg-3 col-md-6">
                <label for="subdistrict" class="form-label">Kecamatan</label>
                <select class="form-select select2" id="subdistrict" name="subdistrict"></select>
              </div>
              <div class="col-lg-3 col-md-6">
                <label for="ward" class="form-label">Kelurahan</label>
                <select class="form-select select2" id="ward" name="ward"></select>
              </div>
            </div>

            <!-- Baris 3 -->
            <div class="row mb-3">
              <div class="col-lg-4 col-md-4">
                <label for="rt" class="form-label">RT</label>
                <input type="number" class="form-control" id="rt" name="rt" placeholder="RT" />
              </div>
              <div class="col-lg-4 col-md-4">
                <label for="rw" class="form-label">RW</label>
                <input type="number" class="form-control" id="rw" name="rw" placeholder="RW" />
              </div>
              <div class="col-lg-4 col-md-4 d-flex align-items-end justify-content-end">
                <button type="submit" class="btn btn-primary px-5"><i class="bi bi-search"></i> Search</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Tabel Hasil -->
      <div class="card shadow-sm">
        <div class="card-body table-wrapper">
          <table id="resultTable" class="table table-striped table-bordered nowrap w-100">
            <thead class="table-light">
              <tr>
                <th>Nama</th>
                <th>Status</th>
                <th>No Telp</th>
                <th>Total Kunjungan</th>
                <th>NIK</th>
                <th>Provinsi</th>
                <th>Kota</th>
                <th>Kecamatan</th>
                <th>Kelurahan</th>
                <th>Kunjungan 1</th>
                <th>Kunjungan 2</th>
                <th>Kunjungan 3</th>
                <th>RT</th>
                <th>RW</th>
                <th>Group</th>
                <th>Tanggal</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- JS Dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      const BASE_URL = 'https://api.noparkeemart.my.id/phones-app/battleship/pemilu';

      let NAME = '';
      let NIK = '';
      let PROVINCE = '';
      let CITY = '';
      let SUBDISTRICT = '';
      let WARD = '';
      let RT = '';
      let RW = '';
      $(document).ready(function () {
        // Inisialisasi Select2
        $('.select2').select2({
          theme: 'bootstrap-5',
          width: '100%',
          placeholder: 'Pilih salah satu',
          allowClear: true,
        });

        $('#province').on('change', async function () {
          const province = $(this).val();
          PROVINCE = province;
          const response = await fetch(`${BASE_URL}/city?province=${province}`);
          const { data } = await response.json();
          $('#city').empty();
          $('#city').append('<option value="">Pilih Kabupaten/Kota</option>');
          data.forEach((d) => {
            $('#city').append(`<option value="${d.city}">${d.city}</option>`);
          });

          if (CITY) {
            $('#city').empty();
            CITY = '';
          }
          if (SUBDISTRICT) {
            $('#subdistrict').empty();
            SUBDISTRICT = '';
          }
          if (WARD) {
            $('#ward').empty();
            WARD = '';
          }
        });

        $('#city').on('change', async function () {
          const city = $(this).val();
          CITY = city;
          const response = await fetch(`${BASE_URL}/subdistrict?province=${PROVINCE}&city=${city}`);
          const { data } = await response.json();
          $('#subdistrict').empty();
          $('#subdistrict').append('<option value="">Pilih Kecamatan</option>');
          data.forEach((d) => {
            $('#subdistrict').append(`<option value="${d.subdistrict}">${d.subdistrict}</option>`);
          });

          if (SUBDISTRICT) {
            $('#subdistrict').empty();
            SUBDISTRICT = '';
          }
          if (WARD) {
            $('#ward').empty();
            WARD = '';
          }
        });

        $('#subdistrict').on('change', async function () {
          const subdistrict = $(this).val();
          console.log('subdistrict:', subdistrict);
          SUBDISTRICT = subdistrict;
          const response = await fetch(`${BASE_URL}/ward?province=${PROVINCE}&city=${CITY}&subdistrict=${subdistrict}`);
          const { data } = await response.json();
          $('#ward').empty();
          $('#ward').append('<option value="">Pilih Kelurahan</option>');
          data.forEach((d) => {
            $('#ward').append(`<option value="${d.ward}">${d.ward}</option>`);
          });

          if (WARD) {
            $('#ward').empty();
            WARD = '';
          }
        });

        $('#ward').on('change', async function () {
          const ward = $(this).val();
          console.log('ward:', ward);
          WARD = ward;
        });

        $('#rt').on('change', async function () {
          const rt = $(this).val();
          console.log('rt:', rt);
          RT = rt;
        });

        $('#rw').on('change', async function () {
          const rw = $(this).val();
          console.log('rw:', rw);
          RW = rw;
        });

        // Inisialisasi DataTable
        const table = $('#resultTable').DataTable({
          data: [],
          columns: [
            { data: 'name' },
            { data: 'status' },
            { data: 'phone' },
            { data: 'total_visit' },
            { data: 'nik' },
            { data: 'province' },
            { data: 'city' },
            { data: 'subdistrict' },
            { data: 'ward' },
            { data: 'visit_1' },
            { data: 'visit_2' },
            { data: 'visit_3' },
            { data: 'rt' },
            { data: 'rw' },
            { data: 'group' },
            { data: 'reg_date' },
          ],
          searching: false,
        });

        // Tangani submit form
        $('#searchForm').on('submit', async function (e) {
          e.preventDefault();

          // Get Data
          NAME = $('#name').val();
          NIK = $('#nik').val();
          const result = await fetch(
            `${BASE_URL}/data?name=${NAME}&nik=${NIK}&province=${PROVINCE}&city=${CITY}&subdistrict=${SUBDISTRICT}&ward=${WARD}&rt=${RT}&rw=${RW}`
          );
          const { data } = await result.json();
          console.log('data:', data);

          // Update tabel
          table.clear().rows.add(data).draw();
        });

        async function getProvinces() {
          const response = await fetch(`${BASE_URL}/province`);
          const { data } = await response.json();
          $('#province').empty();
          $('#province').append('<option value="">Pilih Provinsi</option>');
          data.forEach((d) => {
            $('#province').append(`<option value="${d.province}">${d.province}</option>`);
          });
        }
        getProvinces();
      });
    </script>
  </body>
</html>
